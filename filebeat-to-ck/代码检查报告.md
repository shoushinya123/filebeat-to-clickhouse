# ä»£ç æ ¸å¿ƒé€»è¾‘æ£€æŸ¥æŠ¥å‘Š

## âœ… æ ¸å¿ƒåŠŸèƒ½æ­£ç¡®æ€§

### 1. æ¥æ”¶ Filebeat è¾“å‡º âœ…
- **è·¯ç”±é…ç½®æ­£ç¡®**ï¼š
  - `POST /_bulk` - Elasticsearch bulk API æ ‡å‡†ç«¯ç‚¹
  - `POST /:index/_bulk` - å¸¦ç´¢å¼•çš„ bulk API
  - `POST /:index/:type/_bulk` - å¸¦ç´¢å¼•å’Œç±»å‹çš„ bulk API
- **Filebeat é…ç½®åŒ¹é…**ï¼š`output.elasticsearch` ä¼šå‘é€åˆ°è¿™äº›ç«¯ç‚¹

### 2. Bulk API è§£æé€»è¾‘ âœ… (å·²ä¿®å¤)
- **æ ¼å¼ç†è§£æ­£ç¡®**ï¼šæ¯ä¸¤è¡Œä¸€ç»„ï¼ˆaction + documentï¼‰
- **å®¹é”™å¤„ç†**ï¼š
  - å¤„ç†ç©ºè¡Œ
  - å¤„ç† action è§£æå¤±è´¥çš„æƒ…å†µ
  - å¤„ç† document è§£æå¤±è´¥çš„æƒ…å†µï¼ˆä½¿ç”¨é€šç”¨ JSON è§£æï¼‰

### 3. æ•°æ®è½¬æ¢é€»è¾‘ âœ…
- **å­—æ®µæ˜ å°„æ­£ç¡®**ï¼š
  - `@timestamp` â†’ `timestamp` (DateTime)
  - `message` â†’ `message` (String)
  - `container.name` â†’ `container` (String)
  - `host.name` â†’ `host_name` (String)
  - `docker.container.id` â†’ `docker_container_id` (String)
  - `docker.container.name` â†’ `docker_container_name` (String)
  - `agent.name` â†’ `agent_name` (String)
  - `agent.version` â†’ `agent_version` (String)
  - `log.file.path` â†’ `log_file_path` (String)
  - å®Œæ•´äº‹ä»¶ â†’ `raw_json` (String) - ä½œä¸ºå¤‡ä»½

### 4. ClickHouse å†™å…¥é€»è¾‘ âœ…
- **ä½¿ç”¨ HTTP æ¥å£**ï¼šæœ€ä¿é™©çš„æ–¹å¼
- **æ ¼å¼æ­£ç¡®**ï¼š`JSONEachRow` æ ¼å¼
- **URL ç¼–ç **ï¼šä½¿ç”¨ `url.QueryEscape` ç¡®ä¿å®‰å…¨
- **é”™è¯¯å¤„ç†**ï¼šæ£€æŸ¥ HTTP çŠ¶æ€ç å’Œå“åº”ä½“

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

### 1. Bulk API è§£ææ”¹è¿›
- **é—®é¢˜**ï¼šå½“ action è§£æå¤±è´¥æ—¶ï¼Œä¼šè·³è¿‡ä¸‹ä¸€è¡Œçš„ document
- **ä¿®å¤**ï¼šå¢åŠ äº†å¯¹é action è¡Œçš„å¤„ç†ï¼Œå¯ä»¥ç›´æ¥ä½œä¸º document å¤„ç†

### 2. å®¹é”™æ€§å¢å¼º
- æ”¯æŒå¤šç§æ—¶é—´æˆ³æ ¼å¼
- æ”¯æŒé€šç”¨ JSON è§£æä½œä¸ºåå¤‡æ–¹æ¡ˆ
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“‹ æ ¸å¿ƒæµç¨‹éªŒè¯

```
Filebeat è¾“å‡º
    â†“
POST /_bulk (Elasticsearch bulk API æ ¼å¼)
    â†“
handleBulk() è§£æ
    â†“
æå– events æ•°ç»„
    â†“
writeToClickHouse() è½¬æ¢
    â†“
æ„å»º JSONEachRow æ ¼å¼
    â†“
HTTP POST åˆ° ClickHouse
    â†“
ClickHouse å­˜å‚¨
```

## âœ… éªŒè¯è¦ç‚¹

1. **è¾“å…¥æ ¼å¼æ”¯æŒ**ï¼š
   - âœ… Elasticsearch bulk APIï¼ˆFilebeat é»˜è®¤ï¼‰
   - âœ… JSON äº‹ä»¶æ•°ç»„
   - âœ… å•ä¸ª JSON äº‹ä»¶

2. **æ•°æ®å®Œæ•´æ€§**ï¼š
   - âœ… æ—¶é—´æˆ³æ­£ç¡®è½¬æ¢
   - âœ… æ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„
   - âœ… åŸå§‹ JSON ä¿å­˜åœ¨ raw_json å­—æ®µ

3. **é”™è¯¯å¤„ç†**ï¼š
   - âœ… ç½‘ç»œé”™è¯¯å¤„ç†
   - âœ… ClickHouse é”™è¯¯å“åº”å¤„ç†
   - âœ… JSON è§£æé”™è¯¯å¤„ç†

4. **æ€§èƒ½è€ƒè™‘**ï¼š
   - âœ… æ‰¹é‡å¤„ç†ï¼ˆä¸€æ¬¡å¤„ç†å¤šä¸ªäº‹ä»¶ï¼‰
   - âœ… HTTP è¿æ¥å¤ç”¨ï¼ˆé€šè¿‡ http.Clientï¼‰
   - âœ… è¶…æ—¶è®¾ç½®ï¼ˆ30ç§’ï¼‰

## ğŸ¯ ç»“è®º

**æ ¸å¿ƒé€»è¾‘æ­£ç¡®** âœ…

è½¬æ¢å™¨èƒ½å¤Ÿï¼š
1. âœ… æ­£ç¡®æ¥æ”¶ Filebeat çš„ Elasticsearch bulk API è¾“å‡º
2. âœ… æ­£ç¡®è§£æå’Œè½¬æ¢æ•°æ®æ ¼å¼
3. âœ… æ­£ç¡®å†™å…¥ ClickHouseï¼ˆä½¿ç”¨æœ€ä¿é™©çš„ HTTP æ¥å£ï¼‰

ä»£ç å·²ç»è¿‡ä¿®å¤å’Œä¼˜åŒ–ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚





