# åŠŸèƒ½å®ç°æ–¹å¼è¯¦ç»†è¯´æ˜

## ä¸€ã€æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filebeat   â”‚ â”€â”€â”€â”€â”€â”€> â”‚ è½¬æ¢å™¨       â”‚ â”€â”€â”€â”€â”€â”€> â”‚ ClickHouse  â”‚
â”‚  (æ—¥å¿—æ”¶é›†) â”‚ HTTP    â”‚ (Golang)     â”‚ HTTP    â”‚ (æ•°æ®å­˜å‚¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè½¬è¿‡ç¨‹

1. **Filebeat** æ”¶é›† Docker å®¹å™¨æ—¥å¿—
2. **Filebeat** é€šè¿‡ HTTP å‘é€åˆ°è½¬æ¢å™¨ï¼ˆä½¿ç”¨ Elasticsearch Bulk API æ ¼å¼ï¼‰
3. **è½¬æ¢å™¨** æ¥æ”¶ã€è§£æã€è½¬æ¢æ•°æ®æ ¼å¼
4. **è½¬æ¢å™¨** é€šè¿‡ HTTP å†™å…¥ ClickHouseï¼ˆä½¿ç”¨ JSONEachRow æ ¼å¼ï¼‰

---

## äºŒã€å„ç»„ä»¶å®ç°æ–¹å¼

### 1. Filebeat é…ç½® (`filebeat.yml`)

#### è¾“å…¥é…ç½®
```yaml
filebeat.inputs:
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
```
- **å®ç°æ–¹å¼**: ç›‘æ§ Docker å®¹å™¨æ—¥å¿—æ–‡ä»¶
- **æ•°æ®æº**: `/var/lib/docker/containers/` ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶

#### æ•°æ®å¤„ç†
```yaml
processors:
  - decode_json_fields:  # è§£æ JSON å­—æ®µ
  - add_host_metadata:   # æ·»åŠ ä¸»æœºå…ƒæ•°æ®
  - add_docker_metadata: # æ·»åŠ  Docker å…ƒæ•°æ®
```
- **å®ç°æ–¹å¼**: ä½¿ç”¨ Filebeat å†…ç½®å¤„ç†å™¨å¢å¼ºæ•°æ®

#### è¾“å‡ºé…ç½®
```yaml
output.elasticsearch:
  hosts: ["http://filebeat-to-ck:8080"]
  index: "filebeat-%{+yyyy.MM.dd}"
```
- **å®ç°æ–¹å¼**: ä½¿ç”¨ `output.elasticsearch` è¾“å‡ºåˆ°è½¬æ¢å™¨
- **åè®®**: HTTP + Elasticsearch Bulk API æ ¼å¼
- **ä¸ºä»€ä¹ˆç”¨ Elasticsearch è¾“å‡º**: Filebeat åŸç”Ÿæ”¯æŒï¼Œæ ¼å¼æ ‡å‡†ï¼Œè½¬æ¢å™¨å…¼å®¹æ­¤æ ¼å¼

---

### 2. è½¬æ¢å™¨å®ç° (`filebeat-to-ck/main.go`)

#### 2.1 æŠ€æœ¯æ ˆ
- **è¯­è¨€**: Golang
- **Web æ¡†æ¶**: Gin (è½»é‡çº§ HTTP æ¡†æ¶)
- **é…ç½®è§£æ**: YAML (gopkg.in/yaml.v3)

#### 2.2 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

##### A. é…ç½®ç®¡ç†
```go
type Config struct {
    Server struct {
        Host string `yaml:"host"`
        Port int    `yaml:"port"`
    } `yaml:"server"`
    ClickHouse struct {
        Host     string `yaml:"host"`
        Port     int    `yaml:"port"`
        Database string `yaml:"database"`
        Table    string `yaml:"table"`
        User     string `yaml:"user"`
        Password string `yaml:"password"`
    } `yaml:"clickhouse"`
}
```
- **å®ç°æ–¹å¼**: é€šè¿‡ YAML é…ç½®æ–‡ä»¶åŠ è½½ï¼Œæ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–
- **é…ç½®æ–‡ä»¶è·¯å¾„**: é€šè¿‡ `CONFIG_PATH` ç¯å¢ƒå˜é‡æŒ‡å®š

##### B. HTTP æ¥å£å®ç°

**1. Elasticsearch Bulk API å…¼å®¹æ¥å£**
```go
r.POST("/_bulk", handleBulk)
r.POST("/:index/_bulk", handleBulk)
```
- **å®ç°æ–¹å¼**: è§£æ Elasticsearch Bulk API æ ¼å¼ï¼ˆæ¯ä¸¤è¡Œä¸€ç»„ï¼šaction + documentï¼‰
- **å¤„ç†é€»è¾‘**:
  ```go
  // è§£æ bulk æ ¼å¼
  lines := strings.Split(string(body), "\n")
  for i := 0; i < len(lines); i++ {
      // è§£æ action è¡Œï¼ˆindex, create, update, deleteï¼‰
      // è§£æ document è¡Œï¼ˆå®é™…æ•°æ®ï¼‰
  }
  ```

**2. ç›´æ¥ JSON æ¥æ”¶æ¥å£**
```go
r.POST("/filebeat", handleFilebeat)  // å•ä¸ªäº‹ä»¶
r.POST("/events", handleEvents)      // äº‹ä»¶æ•°ç»„
```
- **å®ç°æ–¹å¼**: ç›´æ¥æ¥æ”¶ JSON æ ¼å¼çš„äº‹ä»¶

**3. Logstash HTTP å…¼å®¹æ¥å£**
```go
r.POST("/logstash", handleLogstash)
```
- **å®ç°æ–¹å¼**: æ”¯æŒ Logstash HTTP è¾“å‡ºæ ¼å¼

##### C. æ•°æ®è½¬æ¢

**äº‹ä»¶ç»“æ„å®šä¹‰**
```go
type FilebeatEvent struct {
    Timestamp interface{}            `json:"@timestamp"`
    Message   string                 `json:"message"`
    Container map[string]interface{} `json:"container,omitempty"`
    Host      map[string]interface{} `json:"host,omitempty"`
    Docker    map[string]interface{} `json:"docker,omitempty"`
    Agent     map[string]interface{} `json:"agent,omitempty"`
    Log       map[string]interface{} `json:"log,omitempty"`
    Extra     map[string]interface{} `json:"-"`
}
```

**é€šç”¨ JSON è½¬æ¢**
```go
func convertGenericToEvent(generic map[string]interface{}) FilebeatEvent {
    // æå–æ—¶é—´æˆ³ã€æ¶ˆæ¯ã€å®¹å™¨ã€ä¸»æœºç­‰ä¿¡æ¯
    // å¤„ç†å„ç§å­—æ®µæ˜ å°„
}
```
- **å®ç°æ–¹å¼**: å°†ä»»æ„ JSON æ ¼å¼è½¬æ¢ä¸ºç»Ÿä¸€çš„ `FilebeatEvent` ç»“æ„

##### D. ClickHouse å†™å…¥

**å†™å…¥å‡½æ•°**
```go
func writeToClickHouse(events []FilebeatEvent) error {
    // 1. æ„å»º JSONEachRow æ ¼å¼æ•°æ®
    var jsonLines []string
    for _, event := range events {
        record := make(map[string]interface{})
        record["timestamp"] = event.GetTimestamp().Format("2006-01-02 15:04:05")
        record["message"] = event.Message
        // ... æå–å…¶ä»–å­—æ®µ
        jsonLines = append(jsonLines, string(jsonBytes))
    }
    
    // 2. æ„å»º HTTP è¯·æ±‚
    query := fmt.Sprintf("INSERT INTO %s.%s FORMAT JSONEachRow", 
        config.ClickHouse.Database, config.ClickHouse.Table)
    requestURL := fmt.Sprintf("http://%s:%d/?query=%s", 
        config.ClickHouse.Host, config.ClickHouse.Port, encodedQuery)
    
    // 3. å‘é€è¯·æ±‚ï¼ˆå¸¦è®¤è¯ï¼‰
    req.SetBasicAuth(config.ClickHouse.User, config.ClickHouse.Password)
    resp, err := client.Do(req)
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:
- **æ ¼å¼**: JSONEachRowï¼ˆClickHouse æœ€å¯é çš„æ¥å£ï¼‰
- **è®¤è¯**: HTTP Basic Auth
- **æ‰¹é‡å†™å…¥**: ä¸€æ¬¡è¯·æ±‚å†™å…¥å¤šæ¡è®°å½•

---

### 3. ClickHouse é…ç½®

#### è¡¨ç»“æ„è®¾è®¡
```sql
CREATE TABLE logs.logs_table
(
    `timestamp` DateTime DEFAULT now(),
    `message` String DEFAULT '',
    `container` String DEFAULT '',
    `host_name` String DEFAULT '',
    `docker_container_id` String DEFAULT '',
    `docker_container_name` String DEFAULT '',
    `agent_name` String DEFAULT '',
    `agent_version` String DEFAULT '',
    `log_file_path` String DEFAULT '',
    `raw_json` String DEFAULT ''  -- å­˜å‚¨å®Œæ•´ JSON
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (timestamp)
```

**è®¾è®¡è¦ç‚¹**:
- **å¼•æ“**: MergeTreeï¼ˆClickHouse æ ‡å‡†å¼•æ“ï¼‰
- **åˆ†åŒº**: æŒ‰æœˆåˆ†åŒºï¼ˆ`toYYYYMM(timestamp)`ï¼‰
- **æ’åº**: æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæé«˜æŸ¥è¯¢æ€§èƒ½ï¼‰
- **çµæ´»æ€§**: `raw_json` å­—æ®µå­˜å‚¨å®Œæ•´ JSONï¼Œä¾¿äºåç»­åˆ†æ

---

## ä¸‰ã€å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Elasticsearch Bulk API è§£æ

**æ ¼å¼ç¤ºä¾‹**:
```
{"index":{}}
{"@timestamp":"2025-12-04T10:00:00Z","message":"test"}
{"index":{}}
{"@timestamp":"2025-12-04T10:01:00Z","message":"test2"}
```

**è§£æé€»è¾‘**:
```go
// æŒ‰è¡Œåˆ†å‰²
lines := strings.Split(string(body), "\n")

// è¯†åˆ« action è¡Œå’Œ document è¡Œ
for i := 0; i < len(lines); i++ {
    line := strings.TrimSpace(lines[i])
    
    // å°è¯•è§£æä¸º action
    var action map[string]interface{}
    if json.Unmarshal([]byte(line), &action) == nil {
        // æ£€æŸ¥æ˜¯å¦åŒ…å« index, create, update, delete
        if isAction {
            // ä¸‹ä¸€è¡Œæ˜¯ document
            i++
            docLine := strings.TrimSpace(lines[i])
            // è§£æ document
        }
    }
}
```

### 2. æ—¶é—´æˆ³å¤„ç†

**å¤šç§æ ¼å¼æ”¯æŒ**:
```go
func (e *FilebeatEvent) GetTimestamp() time.Time {
    switch v := e.Timestamp.(type) {
    case string:
        formats := []string{
            time.RFC3339,
            time.RFC3339Nano,
            "2006-01-02T15:04:05.000Z",
            "2006-01-02T15:04:05Z",
            "2006-01-02 15:04:05",
        }
        // å°è¯•å„ç§æ ¼å¼
    case time.Time:
        return v
    }
}
```

### 3. ClickHouse JSONEachRow æ ¼å¼

**æ ¼å¼è¯´æ˜**:
- æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡
- é€šè¿‡ HTTP POST å‘é€
- URL å‚æ•°åŒ…å« SQL æŸ¥è¯¢

**å®ç°**:
```go
// æ„å»ºæ•°æ®ï¼ˆæ¯è¡Œä¸€ä¸ª JSONï¼‰
data := strings.Join(jsonLines, "\n")

// URL ç¼–ç æŸ¥è¯¢
query := "INSERT INTO logs.logs_table FORMAT JSONEachRow"
encodedQuery := url.QueryEscape(query)

// å‘é€è¯·æ±‚
requestURL := fmt.Sprintf("http://%s:%d/?query=%s", 
    host, port, encodedQuery)
req, _ := http.NewRequest("POST", requestURL, bytes.NewBufferString(data))
```

---

## å››ã€éƒ¨ç½²æ–¹å¼

### 1. Docker Compose ç¼–æ’

```yaml
services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    environment:
      CLICKHOUSE_PASSWORD: shaoxinye123
    
  filebeat-to-ck:
    build: ./filebeat-to-ck
    volumes:
      - ./filebeat-to-ck/config.yaml:/etc/filebeat-to-ck/config.yaml:ro
    
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
```

**ç½‘ç»œé…ç½®**:
- æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€ Docker ç½‘ç»œ (`filebeat-network`)
- é€šè¿‡æœåŠ¡åäº’ç›¸è®¿é—®

### 2. é…ç½®å¤–éƒ¨åŒ–

- **è½¬æ¢å™¨é…ç½®**: é€šè¿‡ volume æŒ‚è½½ `config.yaml`
- **Filebeat é…ç½®**: é€šè¿‡ volume æŒ‚è½½ `filebeat.yml`
- **ClickHouse åˆå§‹åŒ–**: é€šè¿‡ volume æŒ‚è½½ SQL è„šæœ¬

---

## äº”ã€æ‰©å±•æ€§è®¾è®¡

### 1. å¤šè¾“å…¥æºæ”¯æŒ

è½¬æ¢å™¨è®¾è®¡æ”¯æŒå¤šç§ Filebeat è¾“å‡ºæ ¼å¼ï¼š

- âœ… **Elasticsearch Bulk API** (å·²å®ç°)
- âœ… **Logstash HTTP** (å·²å®ç°)
- âœ… **ç›´æ¥ JSON** (å·²å®ç°)
- ğŸ”„ **Logstash TCP** (æ¡†æ¶å·²å‡†å¤‡)
- ğŸ”„ **Kafka** (æ¡†æ¶å·²å‡†å¤‡)
- ğŸ”„ **Redis** (æ¡†æ¶å·²å‡†å¤‡)
- ğŸ”„ **File** (æ¡†æ¶å·²å‡†å¤‡)

### 2. é…ç½®é©±åŠ¨

æ‰€æœ‰åŠŸèƒ½é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶ï¼š
```yaml
inputs:
  elasticsearch:
    enabled: true
  kafka:
    enabled: false
    brokers: ["localhost:9092"]
```

---

## å…­ã€ä¼˜åŠ¿ç‰¹ç‚¹

### 1. å¯é æ€§
- **JSONEachRow**: ClickHouse æœ€å¯é çš„ HTTP æ¥å£
- **æ‰¹é‡å†™å…¥**: æé«˜æ€§èƒ½ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ—¥å¿—å’Œå“åº”

### 2. çµæ´»æ€§
- **å¤šæ ¼å¼æ”¯æŒ**: å…¼å®¹å¤šç§ Filebeat è¾“å‡ºæ ¼å¼
- **é…ç½®é©±åŠ¨**: æ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´
- **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„è¾“å…¥æº

### 3. ç®€å•æ€§
- **å•ä½“åº”ç”¨**: å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ˜“äºéƒ¨ç½²
- **æ— çŠ¶æ€**: æ— æ•°æ®åº“ä¾èµ–ï¼Œæ˜“äºæ‰©å±•
- **è½»é‡çº§**: åŸºäº Gin æ¡†æ¶ï¼Œèµ„æºå ç”¨å°

---

## ä¸ƒã€æ•°æ®æµç¨‹ç¤ºä¾‹

### å®Œæ•´æµç¨‹

1. **Docker å®¹å™¨äº§ç”Ÿæ—¥å¿—**
   ```
   {"message":"åº”ç”¨æ—¥å¿—","level":"info"}
   ```

2. **Filebeat æ”¶é›†å¹¶å¢å¼º**
   ```json
   {
     "@timestamp":"2025-12-04T10:00:00Z",
     "message":"åº”ç”¨æ—¥å¿—",
     "container":{"name":"app"},
     "host":{"name":"server1"}
   }
   ```

3. **Filebeat å‘é€åˆ°è½¬æ¢å™¨ï¼ˆBulk æ ¼å¼ï¼‰**
   ```
   {"index":{}}
   {"@timestamp":"2025-12-04T10:00:00Z","message":"åº”ç”¨æ—¥å¿—",...}
   ```

4. **è½¬æ¢å™¨è§£æå¹¶è½¬æ¢**
   ```go
   event := FilebeatEvent{
       Timestamp: "2025-12-04T10:00:00Z",
       Message: "åº”ç”¨æ—¥å¿—",
       Container: map[string]interface{}{"name":"app"},
   }
   ```

5. **è½¬æ¢å™¨å†™å…¥ ClickHouse**
   ```json
   {"timestamp":"2025-12-04 10:00:00","message":"åº”ç”¨æ—¥å¿—","container":"app"}
   ```

6. **ClickHouse å­˜å‚¨**
   - æŒ‰æ—¶é—´åˆ†åŒºå­˜å‚¨
   - æ”¯æŒé«˜æ•ˆæŸ¥è¯¢å’Œåˆ†æ

---

## å…«ã€æ€»ç»“

### æ ¸å¿ƒå®ç°æ€è·¯

1. **åè®®å…¼å®¹**: è½¬æ¢å™¨å…¼å®¹ Elasticsearch Bulk APIï¼Œæ— éœ€ä¿®æ”¹ Filebeat é…ç½®
2. **æ ¼å¼è½¬æ¢**: å°† Filebeat äº‹ä»¶æ ¼å¼è½¬æ¢ä¸º ClickHouse è¡¨ç»“æ„
3. **å¯é å†™å…¥**: ä½¿ç”¨ ClickHouse çš„ JSONEachRow æ¥å£ï¼Œç¡®ä¿æ•°æ®å¯é æ€§
4. **é…ç½®é©±åŠ¨**: æ‰€æœ‰é…ç½®å¤–éƒ¨åŒ–ï¼Œä¾¿äºéƒ¨ç½²å’Œç»´æŠ¤

### æŠ€æœ¯é€‰å‹ç†ç”±

- **Golang**: æ€§èƒ½å¥½ï¼Œå¹¶å‘èƒ½åŠ›å¼ºï¼Œé€‚åˆé«˜ååé‡åœºæ™¯
- **Gin**: è½»é‡çº§ï¼Œæ€§èƒ½ä¼˜ç§€ï¼ŒAPI ç®€æ´
- **JSONEachRow**: ClickHouse å®˜æ–¹æ¨èï¼Œæœ€å¯é çš„ HTTP æ¥å£
- **Docker Compose**: ç®€åŒ–éƒ¨ç½²ï¼Œç¯å¢ƒä¸€è‡´

è¿™ä¸ªå®ç°æ–¹å¼æ—¢ä¿è¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œåˆä¿æŒäº†ç³»ç»Ÿçš„ç®€æ´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚



